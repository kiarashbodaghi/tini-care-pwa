<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TINIâ€‘Care v0.4 â€” PWA</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --accent:#0ea5e9; --border:#1e293b; --ok:#22c55e; --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Vazirmatn,Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;border:2px solid var(--accent);display:grid;place-items:center}
    .brand b{font-weight:700}
    .tabs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0b1020;color:var(--text);cursor:pointer;font-size:14px}
    .tab.active{background:var(--accent);border-color:var(--accent);color:#001016}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .hero{border:1px solid var(--border);border-radius:20px;overflow:hidden;margin-bottom:14px;background:#0b1020}
    .hero img{width:100%;display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .hint{color:#fcd34d;background:rgba(252,211,77,.08);border:1px solid rgba(252,211,77,.25);border-radius:12px;padding:8px 12px}
    label{display:flex;flex-direction:column;gap:6px;font-size:14px}
    input[type=range],select,button,input[type=number],textarea{width:100%}
    button{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#0b1020;cursor:pointer;color:var(--text)}
    button:hover{background:#0c1324}
    .footer{padding:24px;text-align:center;color:var(--muted);font-size:12px}
    canvas{width:100%;height:220px;background:#0b1020;border:1px solid var(--border);border-radius:12px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.two{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
    .about-list{margin:0;padding-right:18px}
    .about-list li{margin:4px 0}
    a{color:#38bdf8}
    .note{background:#052e3a;border:1px solid #075985;border-radius:12px;padding:10px 12px;color:#b6e3ff}
    .pill{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;margin:2px;background:#0b1020}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">ğŸ”Š</div>
        <div>
          <div><b>TINIâ€‘Care</b> <small class="muted">v0.4</small></div>
          <small class="muted">PWA | Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù„Ø§Ø¦Ù… ÙˆØ²ÙˆØ²</small>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="home">Ø®Ø§Ù†Ù‡</button>
        <button class="tab" data-tab="sound">ØµØ¯Ø§</button>
        <button class="tab" data-tab="assess">Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
        <button class="tab" data-tab="progress">Ù¾ÛŒØ´Ø±ÙØª</button>
        <button class="tab" data-tab="resources">Ù…Ù†Ø§Ø¨Ø¹</button>
        <button class="tab" data-tab="about">Ø¯Ø±Ø¨Ø§Ø±Ù‡</button>
      </div>
    </div>
  </header>

  <main>
    <div class="hero"><img src="banner.png" alt="TINIâ€‘Care banner"></div>

    <!-- HOME -->
    <section class="view" id="view-home">
      <div class="grid">
        <div class="card">
          <div class="title"><h3>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø³Ø±ÛŒØ¹</h3></div>
          <ol class="muted">
            <li>Ø¨Ù‡ ØªØ¨ <b>ØµØ¯Ø§</b> Ø¨Ø±Ùˆ Ùˆ Ø­Ø§Ù„Øª Ø¯Ù„Ø®ÙˆØ§Ù‡ (ØªÙˆÙ†/Ù†ÙˆÛŒØ²/Ù†ÙÙˆÚ†/ØµÙˆØ±ØªÛŒ/Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ/AM) Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</li>
            <li>ÙØ±Ú©Ø§Ù†Ø³ Ù†Ø²Ø¯ÛŒÚ© ÙˆØ²ÙˆØ²ØŒ Ø´Ø¯Øª Ú©Ù…ØŒ Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Q ÙÛŒÙ„ØªØ± Ù†ÙÙˆÚ† Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†.</li>
            <li>Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¨Ù‡ ØªØ¨ <b>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</b> Ø¨Ø±Ùˆ (THI/TFI).</li>
            <li>Ø¯Ø± ØªØ¨ <b>Ù¾ÛŒØ´Ø±ÙØª</b> Ø±ÙˆÙ†Ø¯ ØªØºÛŒÛŒØ± RI/THI/TFI Ø±Ø§ Ø¨Ø¨ÛŒÙ†.</li>
          </ol>
          <p class="hint">âš ï¸ Ø¨Ø§ ÙˆÙ„ÙˆÙ… Ù¾Ø§ÛŒÛŒÙ† Ùˆ Ù‡Ø¯ÙÙˆÙ† Ø§ÛŒÙ…Ù† Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯. Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ø¢Ù…ÙˆØ²Ø´ÛŒ/Ø±ÙØ§Ù‡ÛŒ Ø§Ø³Øª.</p>
          <div>
            <span class="pill">Web Audio</span>
            <span class="pill">PWA</span>
            <span class="pill">Offline</span>
            <span class="pill">LocalStorage</span>
          </div>
        </div>
        <div class="card">
          <div class="title"><h3>Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ø§Ù…Ú©Ø§Ù†Ø§Øª</h3></div>
          <img src="infographic.png" alt="infographic" style="width:100%;border-radius:12px;border:1px solid var(--border)">
        </div>
      </div>
    </section>

    <!-- SOUND -->
    <section class="view" id="view-sound" style="display:none">
      <div class="grid">
        <div class="card">
          <div class="title"><h3>Ù¾Ø®Ø´ ØµØ¯Ø§</h3><button id="startAudio">Ø´Ø±ÙˆØ¹/ØªÙˆÙ‚Ù</button></div>
          <div class="grid">
            <label>Ø­Ø§Ù„Øª ØµØ¯Ø§
              <select id="mode">
                <option value="tone">ØªÙˆÙ† Ø®Ø§Ù„Øµ</option>
                <option value="white">Ù†ÙˆÛŒØ² Ø³ÙÛŒØ¯</option>
                <option value="pink">Ù†ÙˆÛŒØ² ØµÙˆØ±ØªÛŒ</option>
                <option value="brown">Ù†ÙˆÛŒØ² Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ</option>
                <option value="white_notch">Ù†ÙˆÛŒØ² Ø³ÙÛŒØ¯ + Ù†ÙÙˆÚ†</option>
                <option value="am_noise">Ù†ÙˆÛŒØ² Ù…ÙØ¯ÙˆÙ„Ù‡â€ŒØ´Ø¯Ù‡ (AM)</option>
              </select>
            </label>
            <label>ÙØ±Ú©Ø§Ù†Ø³ (Hz)
              <input id="freq" type="range" min="100" max="12000" value="6000" step="10" />
              <small id="freqVal" class="muted">6000 Hz</small>
            </label>
            <label>Ø´Ø¯Øª (dBFS Ù†Ø³Ø¨ÛŒ)
              <input id="gain" type="range" min="-60" max="-6" value="-24" step="1" />
              <small id="gainVal" class="muted">-24 dB</small>
            </label>
            <label>Q ÙÛŒÙ„ØªØ± Ù†ÙÙˆÚ†
              <input id="q" type="range" min="0.5" max="20" value="10" step="0.5" />
              <small id="qVal" class="muted">10</small>
            </label>
            <label>Ø³Ø±Ø¹Øª Ù…ÙØ¯ÙˆÙ„Ø§Ø³ÛŒÙˆÙ† AM (Hz)
              <input id="amRate" type="range" min="0.5" max="20" value="4" step="0.5" />
              <small id="amVal" class="muted">4 Hz</small>
            </label>
          </div>
          <p class="note">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ RI Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù†ÙˆÛŒØ² Ø¨Ø§Ù†Ø¯Ù¾Ù‡Ù† Ø¨Ø§ Ù†ÙÙˆÚ† Ù†Ø²Ø¯ÛŒÚ© ÙØ±Ú©Ø§Ù†Ø³ ÙˆØ²ÙˆØ² ØªØ³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ø§Ù…Ø§ Ù¾Ø§Ø³Ø® Ø§ÙØ±Ø§Ø¯ Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª.</p>
        </div>

        <div class="card">
          <div class="title"><h3>Ø¢Ø²Ù…ÙˆÙ† RI</h3><button id="startRI">Ø´Ø±ÙˆØ¹ RI (Û¶Û° Ø«Ø§Ù†ÛŒÙ‡)</button></div>
          <ol class="muted"><li>ÙØ±Ú©Ø§Ù†Ø³/Q/Ø´Ø¯Øª Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.</li><li>RI Ø±Ø§ Ø¢ØºØ§Ø² Ú©Ù†ÛŒØ¯Ø› Ù¾Ø³ Ø§Ø² ØªÙˆÙ‚Ù Ø§Ù…ØªÛŒØ§Ø² Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</li></ol>
          <div class="two">
            <label>Ø§Ù…ØªÛŒØ§Ø² RI (Û°â€“Û±Û°)
              <input id="riScore" type="number" min="0" max="10" value="0" />
            </label>
            <label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ù„Ø³Ù‡
              <textarea id="note" rows="2" placeholder="Ø­Ø³ Ø´Ù…Ø§ØŒ Ø´Ø±Ø§ÛŒØ· Ù…Ø­ÛŒØ·ØŒ Ù‡Ø¯ÙÙˆÙ† Ù…ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡..."></textarea>
            </label>
          </div>
          <button id="saveSession">Ø°Ø®ÛŒØ±Ù‡ Ø¬Ù„Ø³Ù‡</button>
          <small id="saveMsg" class="muted"></small>
        </div>
      </div>
    </section>

    <!-- ASSESS -->
    <section class="view" id="view-assess" style="display:none">
      <div class="grid">
        <div class="card">
          <div class="title"><h3>THI Ú©ÙˆØªØ§Ù‡ (Û±Û° Ø³Ø¤Ø§Ù„)</h3><button id="saveTHI">Ø«Ø¨Øª THI</button></div>
          <p class="muted">Ù¾Ø§Ø³Ø®: Ø¨Ù„Ù‡=2ØŒ Ú¯Ø§Ù‡ÛŒ=1ØŒ Ø®ÛŒØ±=0</p>
          <div id="thiForm"></div>
          <small class="muted">Ù†Ù…Ø±Ù‡ Ú©Ù„: <b id="thiTotal">0</b></small>
        </div>
        <div class="card">
          <div class="title"><h3>TFI Ú©ÙˆØªØ§Ù‡ (Û±Û° Ø³Ø¤Ø§Ù„)</h3><button id="saveTFI">Ø«Ø¨Øª TFI</button></div>
          <p class="muted">Û° ØªØ§ Û±Û° (Ø´Ø¯Øª/Ø¢Ø²Ø§Ø±Ù†Ø¯Ú¯ÛŒ)</p>
          <div id="tfiForm"></div>
          <small class="muted">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: <b id="tfiAvg">0</b></small>
        </div>
      </div>
    </section>

    <!-- PROGRESS -->
    <section class="view" id="view-progress" style="display:none">
      <div class="grid">
        <div class="card"><div class="title"><h3>Ù†Ù…ÙˆØ¯Ø§Ø± Ø¬Ù„Ø³Ø§Øª (RI/ÙØ±Ú©Ø§Ù†Ø³)</h3><button id="exportAll">Ø®Ø±ÙˆØ¬ÛŒ JSON</button></div><canvas id="chartSessions" width="900" height="240"></canvas></div>
        <div class="card"><div class="title"><h3>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ (THI/TFI)</h3><button id="clearAll">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ù‡</button></div><canvas id="chartScores" width="900" height="240"></canvas></div>
        <div class="card"><h3>Ø³ÙˆØ§Ø¨Ù‚</h3><pre id="log"></pre></div>
      </div>
    </section>

    <!-- RESOURCES -->
    <section class="view" id="view-resources" style="display:none">
      <div class="card">
        <h3>Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø¹ØªØ¨Ø± (Ø¨Ø±Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨ÛŒØ´ØªØ±)</h3>
        <ul class="about-list muted">
          <li>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ù„ÛŒÙ†ÛŒ Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ú¯ÙˆØ´ Ùˆ Ø­Ù„Ù‚ Ùˆ Ø¨ÛŒÙ†ÛŒ Ø¢Ù…Ø±ÛŒÚ©Ø§ (AAOâ€‘HNS): <a href="https://www.entnet.org/quality-practice/quality-products/clinical-practice-guidelines/tinnitus/" target="_blank" rel="noopener">Clinical Practice Guideline: Tinnitus</a></li>
          <li>Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ú©Ø§Ú©Ø±ÛŒÙ† Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Â«ØµÙˆØªâ€ŒØ¯Ø±Ù…Ø§Ù†ÛŒ/Ù…Ø§Ø³Ú©ÛŒÙ†Ú¯Â» Ø¯Ø± ØªÛŒÙ†ÛŒÙ€ØªÙˆØ³: <a href="https://www.cochrane.org/evidence/CD006371_sound-therapy-masking-management-tinnitus-adults" target="_blank" rel="noopener">Cochrane Review</a></li>
          <li>Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø§Ù†Ø¬Ù…Ù† ØªÛŒÙ†ÛŒÙ€ØªÙˆØ³ Ø¢Ù…Ø±ÛŒÚ©Ø§ (ATA) â€” Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ Ùˆ Ù…Ù†Ø§Ø¨Ø¹ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†: <a href="https://www.ata.org/about-tinnitus/patient-tools/patient-resources/" target="_blank" rel="noopener">ATA Resources</a></li>
          <li>Ù…Ø±ÙˆØ± Ø³ÛŒØ³ØªÙ…Ø§ØªÛŒÚ© Â«Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ (Residual Inhibition)Â»: <a href="https://pubmed.ncbi.nlm.nih.gov/33931174/" target="_blank" rel="noopener">PubMed</a></li>
          <li>Ù¾Ø±Ø³Ø´Ù†Ø§Ù…Ù‡ THI (PDF): <a href="https://ata.org/wp-content/uploads/2022/08/Tinnitus_Handicap_Inventory.pdf" target="_blank" rel="noopener">ATA THI PDF</a></li>
          <li>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† (Tinnitus UK): <a href="https://www.tinnitus.org.uk/" target="_blank" rel="noopener">tinnitus.org.uk</a></li>
        </ul>
        <p class="note">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ²ÙˆØ² Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² Ø¢Ù…ÙˆØ²Ø´ØŒ Ø±ÙØªØ§Ø±Ø¯Ø±Ù…Ø§Ù†ÛŒØŒ ØªÙˆØ§Ù†Ø¨Ø®Ø´ÛŒ Ø´Ù†ÙˆØ§ÛŒÛŒ/Ø³Ù…Ø¹Ú© Ùˆ ØµØ¯Ø§Ø³ØªØ› Ù†ØªØ§ÛŒØ¬ ÙØ±Ø¯Ø¨Ù‡â€ŒÙØ±Ø¯ Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª.</p>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="view" id="view-about" style="display:none">
      <div class="card">
        <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” TINIâ€‘Care</h3>
        <p class="muted">
          <b>TINIâ€‘Care</b> ÛŒÚ© ÙˆØ¨â€ŒØ§Ù¾ Ù¾ÛŒØ´â€ŒØ±ÙˆÙ†Ø¯Ù‡ (PWA) Ø¨Ø±Ø§ÛŒ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù„Ø§Ø¦Ù… ÙˆØ²ÙˆØ² Ú¯ÙˆØ´</b> Ø§Ø³Øª. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‡Ø± Ø²Ù…Ø§Ù† Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù Ø§Ø³Øª.
        </p>
        <h4>Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ù…Ù†</h4>
        <p class="muted">
          <b>Ø·Ø±Ø§Ø­/ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡:</b> Ú©ÛŒØ§Ø±Ø´ Ø¨Ø¯Ø§ØºÛŒ (Kiarash Bodaghi)<br/>
          <b>Ù¾Ø±ÙˆÚ˜Ù‡:</b> TINIâ€‘Care (Ù†Ø³Ø®Ù‡ Ù†Ù…Ø§ÛŒØ´ÛŒ Ù¾Ú˜ÙˆÙ‡Ø´ÛŒ)<br/>
          <!-- Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒØ¯: Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø´Ø¨Ú©Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ -->
          <!-- <b>ØªÙ…Ø§Ø³:</b> your-email@example.com -->
        </p>
        <h4>Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ¾Ø°ÛŒØ±ÛŒ</h4>
        <p class="muted">Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ø¢Ù…ÙˆØ²Ø´ÛŒ/Ø±ÙØ§Ù‡ÛŒ Ø§Ø³Øª Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ØªØ´Ø®ÛŒØµ/Ø¯Ø±Ù…Ø§Ù† Ù¾Ø²Ø´Ú©ÛŒ Ù†ÛŒØ³Øª. Ø¨Ø§ ÙˆÙ„ÙˆÙ… Ù¾Ø§ÛŒÛŒÙ† Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø²Ù…ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ù…ØªØ®ØµØµ Ù…Ø´ÙˆØ±Øª Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
      </div>
    </section>
  </main>

  <div class="footer">Â© 2025 TINIâ€‘Care â€” PWA Demo</div>

  <script>
  // -------- Tabs --------
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('.view').forEach(v=>v.style.display='none');
      document.getElementById('view-'+id).style.display='block';
      if(id==='progress'){ renderLog(); drawCharts(); }
    });
  });

  // -------- Audio Engine --------
  let audioCtx=null, masterGain=null, osc=null, noiseNode=null, notch=null, iirPink=null, iirBrown=null, amGain=null, riTimer=null, isPlaying=false;
  const ui = {
    startAudio: document.getElementById('startAudio'), mode: document.getElementById('mode'),
    freq: document.getElementById('freq'), freqVal: document.getElementById('freqVal'),
    gain: document.getElementById('gain'), gainVal: document.getElementById('gainVal'),
    q: document.getElementById('q'), qVal: document.getElementById('qVal'),
    amRate: document.getElementById('amRate'), amVal: document.getElementById('amVal'),
    startRI: document.getElementById('startRI'), riScore: document.getElementById('riScore'),
    note: document.getElementById('note'), saveSession: document.getElementById('saveSession'),
    saveMsg: document.getElementById('saveMsg'), log: document.getElementById('log'),
    exportAll: document.getElementById('exportAll'), clearAll: document.getElementById('clearAll'),
  };
  function dbToLin(db){ return Math.pow(10, db/20); }
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain(); masterGain.gain.value = dbToLin(parseFloat(ui.gain.value)); masterGain.connect(audioCtx.destination);
      notch = audioCtx.createBiquadFilter(); notch.type='notch'; notch.frequency.value=parseFloat(ui.freq.value); notch.Q.value=parseFloat(ui.q.value); notch.connect(masterGain);
      // Pink noise IIR approximation
      const ff = [0.99765, 0.0, 0.0], fb = [1.0, -0.99765, 0.0];
      iirPink = new IIRFilterNode(audioCtx,{feedforward:ff,feedback:fb}); iirPink.connect(notch);
      // Brown noise via lowshelf tilt
      iirBrown = audioCtx.createBiquadFilter(); iirBrown.type = "lowshelf"; iirBrown.frequency.value = 300; iirBrown.gain.value = 15; iirBrown.connect(masterGain);
      // AM
      amGain = audioCtx.createGain(); amGain.gain.value = 1.0;
    }
  }
  function whiteBuffer(){
    const N=2*audioCtx.sampleRate, buf=audioCtx.createBuffer(1,N,audioCtx.sampleRate), data=buf.getChannelData(0);
    for(let i=0;i<N;i++){ data[i]=Math.random()*2-1; } return buf;
  }
  function startTone(){ stopAll(); osc=audioCtx.createOscillator(); osc.type='sine'; osc.frequency.value=parseFloat(ui.freq.value);
    osc.connect(masterGain); osc.start(); isPlaying=true; }
  function startNoise(chainTarget){
    stopAll(); const src = audioCtx.createBufferSource(); src.buffer = whiteBuffer(); src.loop = true; src.connect(chainTarget); src.start();
    noiseNode = src; isPlaying = true;
  }
  function startPink(){ ensureAudio(); startNoise(iirPink); }
  function startWhite(withNotch=false){ ensureAudio(); startNoise(withNotch? iirPink : masterGain); }
  function startBrown(){ ensureAudio(); startNoise(iirBrown); }
  function startAMNoise(){
    stopAll(); ensureAudio();
    const carrier = audioCtx.createBufferSource(); carrier.buffer = whiteBuffer(); carrier.loop=true;
    const lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value=parseFloat(ui.amRate.value);
    const lfoGain = audioCtx.createGain(); lfoGain.gain.value=0.5; // depth 0.5
    lfo.connect(lfoGain); lfoGain.connect(amGain.gain);
    carrier.connect(amGain); amGain.connect(masterGain); carrier.start(); lfo.start();
    noiseNode = carrier; osc = lfo; isPlaying = true;
  }
  function stopAll(){ try{osc?.stop();osc?.disconnect();}catch(e){} try{noiseNode?.stop();noiseNode?.disconnect();}catch(e){} osc=null; noiseNode=null; isPlaying=false; }
  function updateNotch(){ if(!audioCtx) return; notch.frequency.value=parseFloat(ui.freq.value); notch.Q.value=parseFloat(ui.q.value); }
  function updateGain(){ if(audioCtx) masterGain.gain.value = dbToLin(parseFloat(ui.gain.value)); }
  function playCurrent(){ if(!audioCtx) return; const m=ui.mode.value;
    if(m==='tone') startTone();
    if(m==='white') startWhite(false);
    if(m==='white_notch') startWhite(true);
    if(m==='pink') startPink();
    if(m==='brown') startBrown();
    if(m==='am_noise') startAMNoise();
  }
  ui.startAudio.addEventListener('click', async ()=>{ ensureAudio(); if(audioCtx.state==='suspended'){ await audioCtx.resume(); } if(isPlaying){ stopAll(); return; } playCurrent(); });
  ui.mode.addEventListener('change', ()=>{ if(isPlaying) playCurrent(); });
  ui.freq.addEventListener('input', ()=>{ ui.freqVal.textContent = ui.freq.value + " Hz"; updateNotch(); if(osc && osc.frequency) osc.frequency.value = parseFloat(ui.freq.value); });
  ui.gain.addEventListener('input', ()=>{ ui.gainVal.textContent = ui.gain.value + " dB"; updateGain(); });
  ui.q.addEventListener('input', ()=>{ ui.qVal.textContent = ui.q.value; updateNotch(); });
  ui.amRate.addEventListener('input', ()=>{ ui.amVal.textContent = ui.amRate.value + " Hz"; if(osc && osc.frequency) osc.frequency.value = parseFloat(ui.amRate.value); });

  // -------- RI + Storage --------
  ui.startRI.addEventListener('click', async ()=>{
    ensureAudio(); if(audioCtx.state==='suspended'){ await audioCtx.resume(); }
    stopAll(); ui.mode.value='white_notch'; playCurrent(); ui.startRI.disabled=true;
    let seconds=60; const label=ui.startRI.textContent;
    riTimer=setInterval(()=>{ seconds--; ui.startRI.textContent='Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´â€¦ '+seconds+' Ø«Ø§Ù†ÛŒÙ‡';
      if(seconds<=0){ clearInterval(riTimer); stopAll(); ui.startRI.textContent=label; ui.startRI.disabled=false; alert('Ù¾Ø®Ø´ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª. Ø§Ù…ØªÛŒØ§Ø² RI Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.'); }
    },1000);
  });
  function load(k){return JSON.parse(localStorage.getItem(k)||'[]');} function save(k,d){localStorage.setItem(k,JSON.stringify(d));}
  function loadAll(){return{sessions:load('tini_sessions'),thi:load('tini_thi'),tfi:load('tini_tfi')}}
  function renderLog(){ const all=loadAll(); ui.log.textContent = JSON.stringify(all, null, 2); }
  ui.saveSession.addEventListener('click', ()=>{
    const item = { ts:new Date().toISOString(), mode:ui.mode.value, freq:parseFloat(ui.freq.value),
      gainDb:parseFloat(ui.gain.value), q:parseFloat(ui.q.value), amRate:parseFloat(ui.amRate.value), riScore:parseFloat(ui.riScore.value||0),
      note: ui.note.value.trim() };
    const list = load('tini_sessions'); list.push(item); save('tini_sessions', list);
    ui.saveMsg.textContent='âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.'; setTimeout(()=>ui.saveMsg.textContent='',1500); ui.note.value='';
  });
  ui.exportAll.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(loadAll(), null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tini_data.json'; a.click(); URL.revokeObjectURL(url); });
  ui.clearAll.addEventListener('click', ()=>{ if(confirm('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')){ localStorage.removeItem('tini_sessions'); localStorage.removeItem('tini_thi'); localStorage.removeItem('tini_tfi'); renderLog(); drawCharts(); } });

  // -------- Forms THI / TFI --------
  const thiQs = ["Ø¢ÛŒØ§ ÙˆØ²ÙˆØ² ØªÙ…Ø±Ú©Ø² Ø´Ù…Ø§ Ø±Ø§ Ø³Ø®Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ","Ø¢ÛŒØ§ ÙˆØ²ÙˆØ² Ø¨Ø§Ø¹Ø« Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ","Ø¢ÛŒØ§ Ø®ÙˆØ§Ø¨ Ø´Ù…Ø§ Ø±Ø§ Ù…Ø®ØªÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ","Ø¢ÛŒØ§ Ø¯Ø± Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ú©Øª Ø¢Ø²Ø§Ø±Ù†Ø¯Ù‡â€ŒØªØ± Ø§Ø³ØªØŸ",
    "Ø¢ÛŒØ§ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ø§ Ù…Ø®ØªÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ","Ø¢ÛŒØ§ Ø´Ù†ÛŒØ¯Ù† Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø¯Ø´ÙˆØ§Ø±ØªØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ","Ø¢ÛŒØ§ Ø¨Ø§Ø¹Ø« Ø¹ØµØ¨Ø§Ù†ÛŒØª/Ú©Ù„Ø§ÙÚ¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ","Ø¢ÛŒØ§ Ù„Ø°Øª Ø§Ø² Ø²Ù†Ø¯Ú¯ÛŒ Ø±Ø§ Ú©Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ",
    "Ø¢ÛŒØ§ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…Ú© Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ø­Ø³Ø§Ø³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ","Ø¢ÛŒØ§ Ø±ÙˆØ§Ø¨Ø· Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ø´Ù…Ø§ Ø±Ø§ ØªØ­Øªâ€ŒØªØ£Ø«ÛŒØ± Ú¯Ø°Ø§Ø´ØªÙ‡ØŸ"];
  const tfiQs = ["Ø´Ø¯Øª Ú©Ù„ÛŒ ÙˆØ²ÙˆØ²","Ø¢Ø²Ø§Ø±Ù†Ø¯Ú¯ÛŒ ÙˆØ²ÙˆØ²","ØªØ£Ø«ÛŒØ± Ø¨Ø± Ø®ÙˆØ§Ø¨","ØªØ£Ø«ÛŒØ± Ø¨Ø± ØªÙ…Ø±Ú©Ø²","ØªØ£Ø«ÛŒØ± Ø¨Ø± Ø´Ù†ÛŒØ¯Ù†","Ø§Ø³ØªØ±Ø³ Ù†Ø§Ø´ÛŒ Ø§Ø² ÙˆØ²ÙˆØ²","Ú©Ù†ØªØ±Ù„â€ŒÙ¾Ø°ÛŒØ±ÛŒ","Ø¢Ú¯Ø§Ù‡ÛŒ Ø§Ø² ÙˆØ²ÙˆØ² Ø¯Ø± Ø±ÙˆØ²","ØªØ£Ø«ÛŒØ± Ø¨Ø± Ø®Ù„Ù‚","ØªØ£Ø«ÛŒØ± Ø¨Ø± ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§"];
  function renderTHI(){ const box=document.getElementById('thiForm'); box.innerHTML='';
    thiQs.forEach((q,i)=>{ const row=document.createElement('div'); row.className='two';
      row.innerHTML='<label>'+(i+1)+') '+q+'<select data-i="'+i+'" class="thi"><option value="0">Ø®ÛŒØ± (0)</option><option value="1">Ú¯Ø§Ù‡ÛŒ (1)</option><option value="2">Ø¨Ù„Ù‡ (2)</option></select></label>'; box.appendChild(row); });
  }
  function renderTFI(){ const box=document.getElementById('tfiForm'); box.innerHTML='';
    tfiQs.forEach((q,i)=>{ const row=document.createElement('div'); row.innerHTML='<label>'+(i+1)+') '+q+'<input class="tfi" data-i="'+i+'" type="range" min="0" max="10" value="0"/></label>'; box.appendChild(row); });
  }
  function calcTHI(){ let s=0; document.querySelectorAll('select.thi').forEach(el=>s+=parseInt(el.value||0)); document.getElementById('thiTotal').textContent=s; return s; }
  function calcTFI(){ let arr=[]; document.querySelectorAll('input.tfi').forEach(el=>arr.push(parseInt(el.value||0))); const avg=arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length):0; document.getElementById('tfiAvg').textContent=avg.toFixed(1); return avg; }
  document.addEventListener('input', (e)=>{ if(e.target.classList.contains('thi')) calcTHI(); if(e.target.classList.contains('tfi')) calcTFI(); });
  document.getElementById('saveTHI').addEventListener('click', ()=>{ const score=calcTHI(); const list=load('tini_thi'); list.push({ts:new Date().toISOString(), score}); save('tini_thi', list); alert('THI Ø«Ø¨Øª Ø´Ø¯: '+score); });
  document.getElementById('saveTFI').addEventListener('click', ()=>{ const score=calcTFI(); const list=load('tini_tfi'); list.push({ts:new Date().toISOString(), score}); save('tini_tfi', list); alert('TFI Ø«Ø¨Øª Ø´Ø¯: '+score.toFixed(1)); });

  // -------- Charts --------
  function drawLine(ctx, data, color, minY, maxY){
    const w=ctx.canvas.width, h=ctx.canvas.height, pad=24;
    if(!data.length) return;
    const xstep=(w-2*pad)/(Math.max(1,data.length-1));
    ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=2;
    data.forEach((d,i)=>{
      const x = pad + i*xstep;
      const y = pad + (h-2*pad) * (1- (d-minY)/(maxY-minY || 1));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  function clearCanvas(c){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='#0b1020'; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle='#1e293b'; ctx.strokeRect(0,0,c.width,c.height); }
  function drawCharts(){
    const sessions=load('tini_sessions'); const freqs=sessions.map(s=>s.freq); const ris=sessions.map(s=>s.riScore);
    const c1=document.getElementById('chartSessions'); clearCanvas(c1); const x1=c1.getContext('2d');
    if(freqs.length) drawLine(x1, freqs, '#38bdf8', Math.min(...freqs,100), Math.max(...freqs,12000));
    if(ris.length) drawLine(x1, ris, '#22c55e', 0, 10);
    const thi=load('tini_thi').map(x=>x.score); const tfi=load('tini_tfi').map(x=>x.score);
    const c2=document.getElementById('chartScores'); clearCanvas(c2); const x2=c2.getContext('2d');
    if(thi.length) drawLine(x2, thi, '#f97316', 0, 100); if(tfi.length) drawLine(x2, tfi, '#a78bfa', 0, 10);
  }

  // init
  (function init(){
    document.getElementById('freq').dispatchEvent(new Event('input'));
    document.getElementById('gain').dispatchEvent(new Event('input'));
    document.getElementById('q').dispatchEvent(new Event('input'));
    document.getElementById('amRate').dispatchEvent(new Event('input'));
    renderTHI(); renderTFI();
  })();
  </script>
  <script src="sw-register.js"></script>
</body>
</html>
